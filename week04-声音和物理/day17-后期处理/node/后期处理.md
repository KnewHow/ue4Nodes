# Day17-后期处理

## 1 UE4 渲染逻辑

* 前向渲染

  把一个平面形状(几何体)或者立体形状(几何体)变成一个充满像素的2D图片过程叫做光栅化。

  在着色的过程中，每个几何体和每个灯光进行计算，来决定每个几何体的光照情况。这就意味着每个几何体需要考虑场景中的所有灯光。

  优化方案：

  * 优先优化视锥内的模型，对于视锥外或者被遮挡的模型，滞后渲染

    ![image-20200526092123988](../images/image-20200526092123988.png)

  * 不太可行的优化方法：剔除视锥意外的灯光

  传统的OpenGL和DirectX 提供固定的渲染管线中，灯光被限制为8个，即使到现在的图形硬件，可以感知帧速率问题发生之前，前向渲染管线中动态场景灯光也被限制在100个

  固定的物体：

  ![image-20200526092634880](../images/image-20200526092634880.png)

  如果是固定的灯光，则阴影是固定的，此时烘焙灯光，模型的阴影会存储在下面的文件里：

  ![image-20200526092734833](../images/image-20200526092734833.png)

  打开上面文件的内容，都是灯光和阴影信息。

  ![image-20200526092758015](../images/image-20200526092758015.png)

  ![image-20200526093128796](../images/image-20200526093128796.png)

  前向渲染开关：

  ![image-20200526093252615](../images/image-20200526093252615.png)

* 延迟着色(默认)

  延迟着色会将场景中所有物体以无光照形式光栅化到一系列2D图形缓冲区，该缓冲区存储后续光照需要处理的几何信息。我们把这些缓冲区里面的东西称为**几何缓冲**(G-Buffer)。生成G-Buffer后，每个光源将整个场景当作一个几何体处理。每个灯光与所表示的几何相交的像素都是利用期望的光照方程进行着色。

  ![image-20200526095324625](../images/image-20200526095324625.png)

  ![image-20200526093827199](../images/image-20200526093827199.png)

优势：每个光源只针对其覆盖的像素进行计算一次，使用现代硬件渲染不透明的物体，即使是1080P分辨率可以处理2500个动态场景灯光，也不会有帧速率的问题

劣势：只有不透明的物体可以被光栅化到G-Buffer 中，原因是：多个半透明物体可以覆盖同一个像素，而G-Buffer中每个像素只能表示一个值，透明的物体还是通过**前向渲染**进行计算的。



## 2 后期处理

### 2.1 后期处理体系(Post Process Volumn)	

![image-20200526101309389](../images/image-20200526101309389.png)

当摄像机进入该区域内，摄像机的画面就会被处理。

在蓝图中引用

![image-20200526191259838](../images/image-20200526191259838.png)	

### 2.2 场景调色

#### 2.2.1 场景颜色着色（color grading|misc|scene color tint）

![image-20200526102143917](../images/image-20200526102143917.png)

![image-20200526102218134](../images/image-20200526102218134.png)

### 2.2.2 色差(Lens|Chromatic Aberration)

![image-20200526102352959](../images/image-20200526102352959.png)

#### 2.2.3 镜头炫光(Lens|Bloom|intensity)

在摄像机拍摄明亮物体的时候，出现的散射光，这是一种摄像机镜头的物理缺陷。

![image-20200526103048784](../images/image-20200526103048784.png)

#### 2.2.4 阈值（Lens|bloom|threshold）

从哪个亮度开始会产生炫光效果。

![image-20200526103748973](../images/image-20200526103748973.png)

炫光的高级调试：	

![image-20200526104500548](../images/image-20200526104500548.png)

#### 2.2.5 镜头尘埃

显示引擎内容

![image-20200526105351991](../images/image-20200526105351991.png)

找到尘埃：

![image-20200526105513191](../images/image-20200526105513191.png)

引入尘埃：

![image-20200526105902371](../images/image-20200526105902371.png)



#### 2.2.6 镜头散景

![image-20200526110328182](../images/image-20200526110328182.png)

![image-20200526110409010](../images/image-20200526110409010.png)



### 2.3 自动曝光(人眼自适应)

#### 2.3.1 曝光补偿(Lens Exposure)

曝光的对数调整，当数值等于0时，不进行补偿，当数值等于-1时，进行2x偏暗，等于-2时，进行4x偏安，等于1时，进行2x偏亮，等于2时，进行4x偏亮。

![image-20200526111259398](../images/image-20200526111259398.png)



### 2.4 计量模式（统计模式）

打开计量模式显示：

![image-20200526111558349](../images/image-20200526111558349.png)

![image-20200526111613056](../images/image-20200526111613056.png)

#### 2.4.1  自动柱状图统计

![image-20200526112415087](../images/image-20200526112415087.png)

### 2.5 屏幕空间反射(Screen Space Reflect)

屏幕上存在的东西才会被反射。

但是屏幕反射可以做到反射场景里面的东西，但是比较好性能：

![image-20200526113115736](../images/image-20200526113115736.png)

使用平面反射(Planar Reflection.

)也可以达到相同的效果：

![image-20200526113344220](../images/image-20200526113344220.png)

#### 2.5.1 强度

![image-20200526113208872](../images/image-20200526113208872.png)	

#### 2.5.2 质量

![image-20200526113535854](../images/image-20200526113535854.png)



#### 2.5.3 最大粗糙程度

![image-20200526113550580](../images/image-20200526113550580.png)



#### 2.5.4 应用

下雨后，积水的反射。

### 2.6 运动模糊

![image-20200526113830058](../images/image-20200526113830058.png)

打开运行速度图：

![image-20200526113925549](../images/image-20200526113925549.png)



![image-20200526114022046](../images/image-20200526114022046.png)

#### 2.6.1 参数配置

![image-20200526114200026](../images/image-20200526114200026.png)



![image-20200526114608966](../images/image-20200526114608966.png)

### 2.7 屏幕缩放

#### 2.7.1 屏幕缩放百分比

![image-20200526133432990](../images/image-20200526133432990.png)

先将屏幕缩小到原来的百分比，然后在扩大到当前屏幕

![image-20200526133840009](../images/image-20200526133840009.png)

#### 2.7.2 抗锯齿模式开关

![image-20200526134049689](../images/image-20200526134049689.png)



* FXAA: 快速采用抗锯齿
* TemporalAA: 临时抗锯齿
* MSAA 超级采用抗拒是

### 2.8 后期处理体积设置

当有多个后期处理框的时候，我们需要处理多个后期处理框的关系，例如他们的优先级，混合权重等。

在蓝图中使用：

![image-20200526134442812](../images/image-20200526134442812.png)

也可以在面板中配置：

#### 2.8.1 参数设置

![image-20200526135333756](../images/image-20200526135333756.png)



![image-20200526135500845](../images/image-20200526135500845.png)



### 2.9 后期处理体积材质

#### 2.9.1 创建材质

![image-20200526142734969](../images/image-20200526142734969.png)

在后期处理中使用：

![image-20200526142802646](../images/image-20200526142802646.png)



#### 2.9.2 让场景变灰

![image-20200526145555461](../images/image-20200526145555461.png)



#### 2.9.3 让场景有重影

![image-20200526190445239](../images/image-20200526190445239.png)

#### 2.9.4 让场景产生血光闪动

![image-20200526151920467](C:\Users\JHxuhuan2\Desktop\image-20200526151920467.png)

#### 2.9.5 穿墙挂

首先打开模型的自定义深度：

![image-20200526153657797](../images/image-20200526153657797.png)

然后编写材质：

![image-20200526153731744](../images/image-20200526153731744.png)

#### 2.9.6 使用不同的颜色表示穿墙挂

首先打开引擎配置的：

![image-20200526155417885](../images/image-20200526155417885.png)

然后在模型的 Rendering 给不同颜色的模型设置不同的Stencil 值：

![image-20200526155551186](../images/image-20200526155551186.png)

 然后在上一节的蓝图中做如下处理：

![image-20200526160056264](../images/image-20200526160056264.png)

预览的效果：

![image-20200526160136993](../images/image-20200526160136993.png)

#### 2.9.7 优化穿墙挂

看不到显示颜色，否则显示原图：

![image-20200526184919364](../images/image-20200526184919364.png)

